<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ”Š Song ssh ðŸ”Š</title>
    <link href="./style.css" rel="stylesheet">
</head>
<body>
    <h1>ðŸ”Š Song ssh ðŸ”Š</h1>

    <fieldset>
        <legend>SÃ©lection des machines</legend>
        <div id="machines-list"></div>
    </fieldset>

    <fieldset>
        <legend>ParamÃ¨tre</legend>
        <label for="global-slider">Volume :</label>
        <input type="range" id="global-slider" min="0" max="100" value="60" style="margin-left: 10px;">
        <span id="global-slider-value">60%</span>    
    </fieldset>
    
    <button id="connect-selected" class="buttonplay">Play song</button>

    <fieldset>
        <legend>Output</legend>
        <pre id="output" class="output"></pre>
    </fieldset>
    

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        fetch('/machines')
        .then(response => response.json())
        .then(machines => {
            const machinesList = document.getElementById('machines-list');
            
            machines.forEach(machine => {
                const machineDiv = document.createElement('div');
                machineDiv.style.marginBottom = '10px';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `machine-${machine.id}`;
                checkbox.dataset.machineId = machine.id;
                checkbox.dataset.machineNom = machine.nom;

                const label = document.createElement('label');
                label.htmlFor = `machine-${machine.id}`;
                label.textContent = `${machine.nom}`;

                machineDiv.appendChild(checkbox);
                machineDiv.appendChild(label);
                machinesList.appendChild(machineDiv);
            });
        });

        const globalSlider = document.getElementById('global-slider');
        const globalSliderValue = document.getElementById('global-slider-value');
        globalSlider.oninput = () => {
            globalSliderValue.textContent = `${globalSlider.value}%`;
        };

        document.addEventListener('DOMContentLoaded', () => {
        const outputFieldset = document.querySelector('fieldset:nth-of-type(3)');
        const outputPre = document.getElementById('output');

        const updateOutputVisibility = () => {
            if (outputPre.textContent.trim() === "") {
                outputFieldset.style.display = 'none';
            } else {
                outputFieldset.style.display = 'block';
            }
        };

        updateOutputVisibility();

        socket.on('ssh-data', (data) => {
            outputPre.textContent += data + '\n';
            updateOutputVisibility();
        });

        document.getElementById('connect-selected').onclick = () => {
            const selectedMachines = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'));

            if (selectedMachines.length === 0) {
                outputPre.textContent = 'Veuillez sÃ©lectionner au moins une machine.\n';
                updateOutputVisibility();
                return;
            }

            const percentage = globalSlider.value;
            selectedMachines.forEach(checkbox => {
                const machineNom = checkbox.dataset.machineNom;
                const machineId = checkbox.dataset.machineId;
                
                outputPre.textContent += `Connexion en cours Ã  ${machineNom}...\n`;
                socket.emit('ssh-connect', { machineId, percentage });
            });
            updateOutputVisibility();
        };
        });
    </script>
</body>
</html>
